<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Smart Crop Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Roboto:wght@300;400;500&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0faf0;
        }

        h1,
        h2,
        h3,
        .serif {
            font-family: 'Merriweather', serif;
        }

        .sensor-card {
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #ffffff, #f0fdf4);
            border-bottom: 4px solid #16a34a;
        }

        .sensor-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }

        .chart-container {
            position: relative;
            height: 180px;
            width: 100%;
        }

        .crop-card {
            transition: all 0.3s ease;
            cursor: default;
        }

        .crop-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .match-active {
            border: 3px solid #16a34a !important;
            box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.25);
        }

        .match-inactive {
            opacity: 0.45;
            filter: grayscale(55%);
        }

        .climate-override {
            border: 3px solid #f59e0b !important;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.25);
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #d97706;
            margin-top: -5px;
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.5)
            }

            70% {
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0)
            }

            100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0)
            }
        }

        .weather-pulse {
            animation: pulse-ring 2s infinite;
        }
    </style>
</head>

<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-green-800 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-white p-2 rounded-full">
                    <i class="fas fa-leaf text-green-700 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">Agri-Smart</h1>
                    <p class="text-xs text-green-200 uppercase tracking-wider">Climate-Smart Crop Intelligence ¬∑ India
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <!-- Weather Status in Navbar -->
                <div id="weather-nav-badge"
                    class="hidden bg-blue-700 px-3 py-1.5 rounded-full text-xs flex items-center gap-2 border border-blue-500">
                    <i class="fas fa-cloud-sun text-yellow-300"></i>
                    <span id="weather-nav-text" class="font-medium">--</span>
                </div>
                <div
                    class="bg-green-900 px-4 py-1.5 rounded-full text-xs flex items-center gap-2 border border-green-600">
                    <span class="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse shadow-md" id="status-dot"></span>
                    <span id="status-text" class="font-medium tracking-wide">Disconnected</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6 max-w-7xl">

        <!-- Header -->
        <div class="flex justify-between items-end mb-6 border-b border-green-200 pb-2">
            <div>
                <h2 class="text-2xl font-bold text-green-900">Climate-Smart Crop Dashboard</h2>
                <p class="text-sm text-gray-500">Sensor analysis + Live weather ¬∑ Indian Agriculture Standards</p>
            </div>
            <p class="text-sm font-medium text-green-700 hidden md:block" id="current-date">--</p>
        </div>

        <!-- CLIMATE STATUS PANEL -->
        <div id="climate-status-panel" class="mb-6 p-4 rounded-xl border border-blue-200 bg-blue-50 hidden">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div id="weather-icon-big" class="text-3xl">üå§Ô∏è</div>
                    <div>
                        <p class="text-xs font-bold uppercase tracking-wider text-blue-600 mb-0.5">Live Weather ¬∑ <span
                                id="climate-city">--</span></p>
                        <p id="climate-status-text" class="text-sm font-semibold text-blue-900">Fetching weather data...
                        </p>
                    </div>
                </div>
                <div class="flex gap-4 flex-wrap">
                    <div class="text-center">
                        <p class="text-xs text-gray-500">Temp</p>
                        <p class="text-lg font-bold text-orange-600" id="climate-temp">--¬∞C</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500">Humidity</p>
                        <p class="text-lg font-bold text-blue-600" id="climate-humidity">--%</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500">Forecast</p>
                        <p class="text-lg font-bold text-indigo-600" id="climate-forecast">--</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500">Wind</p>
                        <p class="text-lg font-bold text-teal-600" id="climate-wind">-- m/s</p>
                    </div>
                </div>
                <div id="climate-override-badge"
                    class="hidden px-3 py-1.5 rounded-full text-xs font-bold bg-amber-100 text-amber-800 border border-amber-300 weather-pulse">
                    ‚ö° CLIMATE OVERRIDE ACTIVE
                </div>
            </div>


            <!-- Climate Advisory -->
            <div id="climate-advisory" class="mt-3 text-xs text-blue-700 bg-blue-100 rounded-lg px-3 py-2 hidden"></div>
        </div>

        <!-- RECOMMENDATION BANNER -->
        <div id="recommendation-banner"
            class="mb-8 p-5 rounded-xl border-l-8 shadow-sm flex items-center gap-5 transition-colors duration-500 bg-gray-100 border-gray-400">
            <div id="crop-img-container" class="hidden md:block flex-shrink-0">
                <img id="crop-banner-img" src="" alt="Crop"
                    class="w-28 h-28 rounded-xl object-cover shadow-md border-2 border-white"
                    onerror="this.style.display='none'">
            </div>
            <div class="flex-grow">
                <div class="flex items-center gap-2 mb-1">
                    <h3 class="text-xs font-bold uppercase tracking-widest opacity-60">Best Crop Match</h3>
                    <span id="climate-tag"
                        class="hidden text-[10px] bg-amber-100 text-amber-700 border border-amber-300 px-2 py-0.5 rounded-full font-bold">üå¶
                        Climate Override</span>
                </div>
                <h2 id="recommended-crop" class="text-3xl font-bold text-gray-800 mb-1">Analyzing...</h2>
                <p id="recommendation-reason" class="text-sm text-gray-600">Waiting for sensor data.</p>
                <div class="mt-2 flex gap-2 flex-wrap" id="crop-params-display"></div>
            </div>
            <div class="hidden md:flex flex-col items-center gap-1 flex-shrink-0">
                <div id="safety-badge" class="px-4 py-2 rounded-full text-sm font-bold bg-gray-200 text-gray-600">--
                </div>
                <p class="text-xs text-gray-400">Field Safety</p>
            </div>
        </div>

        <!-- GEMINI AI INSIGHT CARD -->
        <div
            class="mb-8 p-6 rounded-xl bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 shadow-sm relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i class="fas fa-robot text-9xl text-purple-900"></i>
            </div>
            <div class="relative z-10">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-white p-2 rounded-full shadow-sm">
                        <i class="fas fa-sparkles text-purple-600 text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">Gemini AI Agri-Analyst</h3>
                    <span
                        class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full font-bold border border-purple-200">BETA</span>
                </div>

                <p class="text-gray-600 mb-6 max-w-2xl">
                    Get real-time, context-aware agricultural advice based on your specific sensor readings and local
                    weather conditions. Powered by Google Gemini.
                </p>

                <div class="flex flex-col md:flex-row gap-4 items-start">
                    <button onclick="callGeminiAI()" id="gemini-btn"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center gap-2 transition-all transform hover:scale-105">
                        <i class="fas fa-brain"></i> Analyze Field with AI
                    </button>

                    <div id="gemini-result"
                        class="hidden flex-grow bg-white p-5 rounded-lg border border-purple-100 shadow-inner w-full">
                        <div
                            class="flex items-center gap-2 mb-2 text-purple-800 font-bold border-b border-purple-100 pb-2">
                            <i class="fas fa-comment-dots"></i> AI Analysis
                        </div>
                        <div id="gemini-content"
                            class="text-gray-700 text-sm leading-relaxed prose prose-purple max-w-none">
                            <!-- AI Response will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SENSOR GRID -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="sensor-card p-5 rounded-xl">
                <div class="flex justify-between items-start mb-3">
                    <h4 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Turbidity</h4>
                    <i class="fas fa-water text-blue-300 text-lg"></i>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="turbidity-value" class="text-3xl font-bold text-gray-800">--</span>
                    <span class="text-xs text-gray-400">NTU</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-3 mb-1">
                    <div id="turbidity-bar" class="bg-blue-500 h-1.5 rounded-full transition-all" style="width:0%">
                    </div>
                </div>
                <p id="turbidity-status" class="text-xs text-blue-600 font-medium text-right">--</p>
            </div>
            <div class="sensor-card p-5 rounded-xl relative">
                <div class="absolute top-2 right-2 text-[9px] text-gray-400 bg-gray-100 px-1 rounded">Depth = 150cm ‚àí
                    Distance</div>
                <div class="flex justify-between items-start mb-3">
                    <h4 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Water Depth (JSN)</h4>
                    <i class="fas fa-ruler-vertical text-indigo-300 text-lg"></i>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="water-value" class="text-3xl font-bold text-gray-800">--</span>
                    <span class="text-xs text-gray-400">cm</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-3 mb-1">
                    <div id="water-bar" class="bg-indigo-500 h-1.5 rounded-full transition-all" style="width:0%"></div>
                </div>
                <p id="water-status" class="text-xs text-indigo-600 font-medium text-right">--</p>
                <p class="text-[10px] text-gray-400 mt-0.5">Raw distance: <span id="raw-dist">--</span> cm</p>
            </div>
            <div class="sensor-card p-5 rounded-xl">
                <div class="flex justify-between items-start mb-3">
                    <h4 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Salinity (TDS)</h4>
                    <i class="fas fa-flask text-yellow-400 text-lg"></i>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="tds-value" class="text-3xl font-bold text-gray-800">--</span>
                    <span class="text-xs text-gray-400">ppm</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-3 mb-1">
                    <div id="tds-bar" class="bg-yellow-500 h-1.5 rounded-full transition-all" style="width:0%"></div>
                </div>
                <p id="tds-status" class="text-xs text-yellow-600 font-medium text-right">--</p>
            </div>
        </div>

        <!-- CROP CARDS GRID -->
        <div class="mb-8">
            <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                <i class="fas fa-seedling text-green-600"></i> Crop Suitability Reference
                <span class="text-xs font-normal text-gray-400 ml-2">(Green = Sensor Match ¬∑ Amber = Climate
                    Override)</span>
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="crop-cards-container"></div>
        </div>

        <!-- GRAPHS -->
        <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 mb-8">
            <h3 class="text-lg font-bold text-gray-700 mb-5 flex items-center gap-2">
                <i class="fas fa-chart-line text-green-600"></i> Field Analysis Trends
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="chart-container"><canvas id="chart-turbidity"></canvas></div>
                <div class="chart-container"><canvas id="chart-water"></canvas></div>
                <div class="chart-container"><canvas id="chart-tds"></canvas></div>
            </div>
        </div>

        <!-- SIMULATION PANEL -->
        <div class="bg-amber-50 border border-amber-200 rounded-xl p-6" id="simulation-panel">
            <div class="flex justify-between items-center mb-5">
                <div>
                    <h3 class="text-lg font-bold text-amber-900 flex items-center gap-2 serif">
                        <i class="fas fa-tractor"></i> Field Simulation
                    </h3>
                    <p class="text-xs text-amber-700 mt-1">Adjust sliders to test crop scenarios. Weather data is always
                        live.</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="sim-toggle" class="sr-only peer" checked>
                    <div
                        class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:bg-amber-600 transition-colors relative">
                        <div
                            class="absolute left-[2px] top-[2px] bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-full">
                        </div>
                    </div>
                    <span class="ml-2 text-xs font-bold text-amber-800 uppercase">Sim Active</span>
                </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-bold text-amber-800 uppercase">Turbidity (NTU)</label>
                        <span class="text-xs font-mono bg-amber-100 px-2 rounded text-amber-800"
                            id="disp-sim-turbidity">--</span>
                    </div>
                    <input type="range" id="sim-turbidity" min="0" max="1000" value="50"
                        class="w-full h-2 bg-amber-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-[10px] text-amber-600 mt-1"><span>Clear (0)</span><span>Muddy
                            (1000)</span></div>
                </div>
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-bold text-amber-800 uppercase">Water Depth (cm)</label>
                        <span class="text-xs font-mono bg-amber-100 px-2 rounded text-amber-800"
                            id="disp-sim-water">--</span>
                    </div>
                    <input type="range" id="sim-water-depth" min="0" max="150" value="5"
                        class="w-full h-2 bg-amber-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-[10px] text-amber-600 mt-1"><span>Dry (0)</span><span>Deep
                            Flood (150cm)</span></div>
                </div>
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-bold text-amber-800 uppercase">TDS (ppm)</label>
                        <span class="text-xs font-mono bg-amber-100 px-2 rounded text-amber-800"
                            id="disp-sim-tds">--</span>
                    </div>
                    <input type="range" id="sim-tds" min="0" max="2000" value="400"
                        class="w-full h-2 bg-amber-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-[10px] text-amber-600 mt-1"><span>Fresh (0)</span><span>Saline
                            (2000)</span></div>
                </div>
            </div>
        </div>

        <footer class="mt-10 text-center text-gray-400 text-sm pb-8">
            <p>&copy; 2024 ResQTech Agri-Solutions ¬∑ Climate-Smart Indian Agriculture</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // =============================================
        // FIREBASE CONFIG (UNCHANGED)
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCwbAvPWJA9iPpJXFyb5osGHD001lT2ve0",
            authDomain: "resqtech-929a9.firebaseapp.com",
            databaseURL: "https://resqtech-929a9-default-rtdb.firebaseio.com",
            projectId: "resqtech-929a9",
            storageBucket: "resqtech-929a9.firebasestorage.app",
            messagingSenderId: "147944644317",
            appId: "1:147944644317:web:089abbe2e66e9a7644c534"
        };

        // =============================================
        // GEMINI AI CONFIG
        // =============================================
        const GEMINI_API_KEY = "XXXXX-XXXXXXXX"; // User provided key

        // =============================================
        // WEATHER API CONFIG
        // NOTE: Replace with your own free key from openweathermap.org
        // =============================================
        const OWM_API_KEY = "YOUR_OPENWEATHERMAP_API_KEY"; // <-- Replace this
        const OWM_CITY = "Kochi,IN";  // Change to your city, e.g. "Delhi,IN" or "Mumbai,IN"

        // =============================================
        // CROP DATABASE (Real-world Indian Agriculture)
        // Thresholds: waterDepth (cm), turbidity (NTU), tds (ppm)
        // =============================================
        const CROPS = [
            {
                id: "deep-rice",
                name: "Deep Water Rice",
                variety: "Varshadhan",
                icon: "üåæ",
                // Local image: images/deep-rice.jpg
                image: "images/deep-rice.jpg",
                color: "green",
                waterMin: 50, waterMax: 150,
                turbidityMin: 400, turbidityMax: 1000,
                tdsMin: 0, tdsMax: 1500,
                description: "Highly silt-tolerant variety for deep monsoon floodwaters. Suited for stagnant, silty conditions in Indian river plains.",
                params: "Water: 50‚Äì150cm | Turbidity: >400 NTU | TDS: <1500 ppm"
            },
            {
                id: "swarna-sub1",
                name: "Swarna-Sub1 Rice",
                variety: "Submergence Tolerant",
                icon: "üåä",
                // Local image: images/swarna-sub1.jpg
                image: "images/swarna-sub1.jpg",
                color: "blue",
                waterMin: 20, waterMax: 150,
                turbidityMin: 0, turbidityMax: 1000,
                tdsMin: 0, tdsMax: 1500,
                description: "Sub1 gene allows survival under 14 days of complete submergence. Ideal when rain forecast predicts rising flood levels.",
                params: "Water: >20cm | Any Turbidity | TDS: <1500 ppm | Rain Forecast"
            },
            {
                id: "rice",
                name: "Paddy Rice",
                variety: "IR-64 / Swarna",
                icon: "üåæ",
                // Local image: images/rice.jpg
                image: "images/rice.jpg",
                color: "emerald",
                waterMin: 5, waterMax: 50,
                turbidityMin: 0, turbidityMax: 300,
                tdsMin: 0, tdsMax: 1000,
                description: "Standard paddy rice for Indian monsoon season. Requires 5‚Äì15cm standing water. Sensitive to salinity above 3 dS/m.",
                params: "Water: 5‚Äì50cm | Turbidity: <300 NTU | TDS: <1000 ppm"
            },
            {
                id: "wheat",
                name: "Wheat",
                variety: "HD-2967 / GW-322",
                icon: "üåø",
                // Local image: images/wheat.jpg
                image: "images/wheat.jpg",
                color: "yellow",
                waterMin: 0, waterMax: 10,
                turbidityMin: 0, turbidityMax: 100,
                tdsMin: 200, tdsMax: 1200,
                description: "Rabi crop requiring moist but well-drained soil. No standing water tolerated. Optimal in cool, dry winters (temp < 20¬∞C).",
                params: "Water: 0‚Äì10cm | Turbidity: <100 NTU | TDS: 200‚Äì1200 ppm | Temp: <20¬∞C"
            },
            {
                id: "mustard",
                name: "Mustard",
                variety: "Pusa Bold / RH-749",
                icon: "üåº",
                // Local image: images/mustard.jpg
                image: "images/mustard.jpg",
                color: "yellow",
                waterMin: 0, waterMax: 8,
                turbidityMin: 0, turbidityMax: 80,
                tdsMin: 100, tdsMax: 1000,
                description: "Winter oilseed crop. Grows well in cool, dry conditions alongside wheat. Tolerates mild salinity. Requires well-drained soil.",
                params: "Water: 0‚Äì8cm | Turbidity: <80 NTU | TDS: 100‚Äì1000 ppm | Temp: <20¬∞C"
            },
            {
                id: "barley",
                name: "Barley",
                variety: "K-572 / NDB-1173",
                icon: "üåæ",
                // Local image: images/barley.jpg
                image: "images/barley.jpg",
                color: "amber",
                waterMin: 0, waterMax: 10,
                turbidityMin: 0, turbidityMax: 150,
                tdsMin: 500, tdsMax: 2000,
                description: "Most salt-tolerant cereal crop. Recommended when TDS > 1000 ppm and temperatures are high. Suitable for saline-prone fields.",
                params: "Water: 0‚Äì10cm | Turbidity: <150 NTU | TDS: 500‚Äì2000 ppm | High Temp"
            },
            {
                id: "sugarcane",
                name: "Sugarcane",
                variety: "Co-86032 / CoJ-64",
                icon: "üéã",
                // Local image: images/sugarcane.jpg
                image: "images/sugarcane.jpg",
                color: "lime",
                waterMin: 0, waterMax: 15,
                turbidityMin: 0, turbidityMax: 200,
                tdsMin: 100, tdsMax: 1500,
                description: "High water demand (1800‚Äì2200mm/season) but no waterlogging. Requires well-drained soil. Moderately sensitive to salinity.",
                params: "Water: 0‚Äì15cm | Turbidity: <200 NTU | TDS: <1500 ppm"
            },
            {
                id: "coffee",
                name: "Coffee",
                variety: "Robusta / Arabica",
                icon: "‚òï",
                // Local image: images/coffee.jpg
                image: "images/coffee.jpg",
                color: "amber",
                waterMin: 0, waterMax: 5,
                turbidityMin: 0, turbidityMax: 50,
                tdsMin: 50, tdsMax: 700,
                description: "Grown in Western Ghats. Requires well-drained soil. Excessive moisture is harmful. TDS 50‚Äì700 ppm ideal (field studies: 82‚Äì618 mg/L).",
                params: "Water: 0‚Äì5cm | Turbidity: <50 NTU | TDS: 50‚Äì700 ppm"
            },
            {
                id: "tea",
                name: "Tea",
                variety: "Assam / Darjeeling",
                icon: "üçµ",
                // Local image: images/tea.jpg
                image: "images/tea.jpg",
                color: "teal",
                waterMin: 0, waterMax: 5,
                turbidityMin: 0, turbidityMax: 80,
                tdsMin: 50, tdsMax: 600,
                description: "Requires water table 90cm below surface. Waterlogging is a limiting factor. Grown in Assam, Darjeeling, Nilgiris. Low TDS preferred.",
                params: "Water: 0‚Äì5cm | Turbidity: <80 NTU | TDS: 50‚Äì600 ppm"
            },
            {
                id: "cardamom",
                name: "Cardamom",
                variety: "Malabar / Mysore",
                icon: "üå±",
                // Local image: images/cardamom.jpg
                image: "images/cardamom.jpg",
                color: "green",
                waterMin: 0, waterMax: 5,
                turbidityMin: 0, turbidityMax: 60,
                tdsMin: 50, tdsMax: 500,
                description: "Grown in Kerala/Karnataka hills. Requires excellent drainage (45cm deep drains). Sensitive to waterlogging. Low TDS essential.",
                params: "Water: 0‚Äì5cm | Turbidity: <60 NTU | TDS: 50‚Äì500 ppm"
            },
            {
                id: "water-chestnut",
                name: "Water Chestnut",
                variety: "Singhara",
                icon: "üåä",
                // Local image: images/water-chestnut.jpg
                image: "images/water-chestnut.jpg",
                color: "cyan",
                waterMin: 15, waterMax: 50,
                turbidityMin: 0, turbidityMax: 400,
                tdsMin: 0, tdsMax: 600,
                description: "Aquatic crop for semi-deep freshwater bodies. Thrives in 15‚Äì50cm standing water. Requires low salinity. Common in UP, Bihar, MP.",
                params: "Water: 15‚Äì50cm | Turbidity: <400 NTU | TDS: <600 ppm"
            }
        ];

        // =============================================
        // CONSTANTS & STATE
        // =============================================
        const SENSOR_MAX_HEIGHT_CM = 150;
        const maxPoints = 20;

        let currentData = { turbidity: 50, waterDepth: 5, rawDistance: 0, tds: 400 };
        let weatherData = {
            temp: null, humidity: null, forecast: null, wind: null,
            city: null, icon: null, loaded: false
        };

        // =============================================
        // UI REFS
        // =============================================
        const ui = {
            turbidity: document.getElementById('turbidity-value'),
            turbidityStatus: document.getElementById('turbidity-status'),
            turbidityBar: document.getElementById('turbidity-bar'),
            water: document.getElementById('water-value'),
            waterStatus: document.getElementById('water-status'),
            waterBar: document.getElementById('water-bar'),
            rawDist: document.getElementById('raw-dist'),
            tds: document.getElementById('tds-value'),
            tdsStatus: document.getElementById('tds-status'),
            tdsBar: document.getElementById('tds-bar'),
            recCrop: document.getElementById('recommended-crop'),
            recReason: document.getElementById('recommendation-reason'),
            cropBannerImg: document.getElementById('crop-banner-img'),
            cropParamsDisplay: document.getElementById('crop-params-display'),
            safetyBadge: document.getElementById('safety-badge'),
            banner: document.getElementById('recommendation-banner'),
            climateTag: document.getElementById('climate-tag'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            dateDisplay: document.getElementById('current-date'),
            simPanel: document.getElementById('simulation-panel'),
            simToggle: document.getElementById('sim-toggle'),
            simTurbidity: document.getElementById('sim-turbidity'),
            simWaterDepth: document.getElementById('sim-water-depth'),
            simTDS: document.getElementById('sim-tds'),
            // Climate panel
            climatePanel: document.getElementById('climate-status-panel'),
            climateCity: document.getElementById('climate-city'),
            climateStatusText: document.getElementById('climate-status-text'),
            climateTemp: document.getElementById('climate-temp'),
            climateHumidity: document.getElementById('climate-humidity'),
            climateForecast: document.getElementById('climate-forecast'),
            climateWind: document.getElementById('climate-wind'),
            climateIconBig: document.getElementById('weather-icon-big'),
            climateOverrideBadge: document.getElementById('climate-override-badge'),
            climateAdvisory: document.getElementById('climate-advisory'),
            weatherNavBadge: document.getElementById('weather-nav-badge'),
            weatherNavText: document.getElementById('weather-nav-text'),
        };

        // =============================================
        // WEATHER API ‚Äî getClimateSmartCrop()
        // =============================================

        /**
         * Fetches live weather fro
         *
         * @param {number} waterLevel  - Water depth in cm
         * @param {number} tds         - TDS in ppm
         * @param {number} turbidity   - Turbidity in NTU
         * @param {number} ambientTemp - Temperature in ¬∞C (from OWM)
         * @param {number} humidity    - Humidity in % (from OWM)
         * @param {string} weatherForecast - Main weather description e.g. 'Rain', 'Clear'
         * @returns {{ crop, reason, isOverride, advisoryMsg }}
         */
        function getClimateSmartCrop(waterLevel, tds, turbidity, ambientTemp, humidity, weatherForecast) {
            const forecast = weatherForecast ? weatherForecast.toLowerCase() : '';
            const isRain = forecast.includes('rain') || forecast.includes('drizzle') || forecast.includes('thunderstorm');

            // ‚îÄ‚îÄ RULE A: Flood Prediction Override ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // If rain is forecast AND water is already rising (>20cm), switch to
            // Swarna-Sub1 which survives 14 days of complete submergence.
            if (isRain && waterLevel > 20) {
                return {
                    cropId: "swarna-sub1",
                    crop: "Swarna-Sub1 Rice",
                    reason: `‚ö† Flood Prediction: Rain forecast + ${Math.floor(waterLevel)}cm water level. Swarna-Sub1 survives 14 days of complete submergence ‚Äî critical for disaster preparedness.`,
                    isOverride: true,
                    advisoryMsg: `üåß Rain forecast detected. Water level at ${Math.floor(waterLevel)}cm and rising. Swarna-Sub1 (Sub1 gene) is the safest choice ‚Äî it can survive complete submergence for up to 14 days.`
                };
            }

            // ‚îÄ‚îÄ RULE B: Monsoon Deep-Water Confirmation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // High water + hot + humid = classic Indian monsoon deep-water scenario.
            if (waterLevel >= 50 && ambientTemp > 25 && humidity > 70) {
                return {
                    cropId: "deep-rice",
                    crop: "Deep Water Rice (Varshadhan)",
                    reason: `Monsoon deep-water conditions confirmed: ${Math.floor(waterLevel)}cm depth, ${ambientTemp}¬∞C, ${humidity}% humidity. Varshadhan is the optimal choice for Indian monsoon floodwaters.`,
                    isOverride: true,
                    advisoryMsg: `üå° Hot & humid monsoon conditions (${ambientTemp}¬∞C, ${humidity}% RH) with deep flooding. Varshadhan deep-water rice is confirmed as the best match.`
                };
            }

            // ‚îÄ‚îÄ RULE C: Winter Transition ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Cool temperatures + low water = Rabi season. Wheat or Mustard.
            if (ambientTemp < 20 && waterLevel < 15) {
                const isWheat = tds >= 200 && tds <= 1200 && turbidity < 100;
                return {
                    cropId: isWheat ? "wheat" : "mustard",
                    crop: isWheat ? "Wheat (HD-2967)" : "Mustard (Pusa Bold)",
                    reason: `Winter transition detected: ${ambientTemp}¬∞C ambient temperature. ${isWheat ? 'Wheat' : 'Mustard'} is optimal for Rabi season with low water levels and cool conditions.`,
                    isOverride: true,
                    advisoryMsg: `‚ùÑ Winter Rabi season conditions detected (${ambientTemp}¬∞C). ${isWheat ? 'Wheat' : 'Mustard'} recommended for cool, dry field conditions.`
                };
            }

            // ‚îÄ‚îÄ RULE D: Salinity Alert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Hot + high TDS = Barley (most salt-tolerant cereal).
            if (ambientTemp > 35 && tds > 1000) {
                return {
                    cropId: "barley",
                    crop: "Barley (K-572)",
                    reason: `‚ö† Salinity Alert: TDS ${Math.floor(tds)} ppm + ${ambientTemp}¬∞C heat. Barley has the highest salinity tolerance among cereals and is recommended for these conditions.`,
                    isOverride: true,
                    advisoryMsg: `üå° High heat (${ambientTemp}¬∞C) + high salinity (${Math.floor(tds)} ppm). Barley is the most salt-tolerant cereal and is recommended to prevent crop failure.`
                };
            }

            // No climate override ‚Äî use sensor-based matching
            return { cropId: null, crop: null, reason: null, isOverride: false, advisoryMsg: null };
        }

        // =============================================
        // FETCH WEATHER DATA
        // =============================================
        async function fetchWeather() {
            // If no API key set, use mock data for demonstration
            if (!OWM_API_KEY || OWM_API_KEY === "YOUR_OPENWEATHERMAP_API_KEY") {
                console.warn("No OWM API key set. Using mock weather data for demonstration.");
                weatherData = {
                    temp: 28, humidity: 75, forecast: "Rain",
                    wind: 4.2, city: OWM_CITY.split(',')[0],
                    icon: "üåß", loaded: true
                };
                updateClimateUI();
                return;
            }

            try {
                const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(OWM_CITY)}&appid=${OWM_API_KEY}&units=metric`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`OWM API error: ${res.status}`);
                const data = await res.json();

                const mainDesc = data.weather[0].main; // e.g. "Rain", "Clear", "Clouds"
                const iconCode = data.weather[0].icon;
                const iconMap = {
                    '01': '‚òÄÔ∏è', '02': 'üå§Ô∏è', '03': '‚òÅÔ∏è', '04': '‚òÅÔ∏è',
                    '09': 'üåß', '10': 'üå¶', '11': '‚õà', '13': '‚ùÑÔ∏è', '50': 'üå´'
                };
                const iconKey = iconCode.substring(0, 2);

                weatherData = {
                    temp: Math.round(data.main.temp),
                    humidity: data.main.humidity,
                    forecast: mainDesc,
                    wind: data.wind.speed.toFixed(1),
                    city: data.name,
                    icon: iconMap[iconKey] || 'üå§Ô∏è',
                    loaded: true
                };
                updateClimateUI();
            } catch (err) {
                console.error("Weather fetch failed:", err);
                ui.climateStatusText.innerText = "Weather data unavailable. Using sensor-only mode.";
            }
        }

        function updateClimateUI() {
            if (!weatherData.loaded) return;
            ui.climatePanel.classList.remove('hidden');
            ui.weatherNavBadge.classList.remove('hidden');
            ui.climateCity.innerText = weatherData.city;
            ui.climateTemp.innerText = `${weatherData.temp}¬∞C`;
            ui.climateHumidity.innerText = `${weatherData.humidity}%`;
            ui.climateForecast.innerText = weatherData.forecast;
            ui.climateWind.innerText = `${weatherData.wind} m/s`;
            ui.climateIconBig.innerText = weatherData.icon;
            ui.climateStatusText.innerText = `${weatherData.forecast} ¬∑ ${weatherData.temp}¬∞C ¬∑ ${weatherData.humidity}% RH`;
            ui.weatherNavText.innerText = `${weatherData.icon} ${weatherData.temp}¬∞C ¬∑ ${weatherData.forecast}`;
        }

        // =============================================
        // BUILD CROP CARDS
        // =============================================
        function buildCropCards() {
            const container = document.getElementById('crop-cards-container');
            container.innerHTML = '';
            const colorMap = {
                green: 'border-green-400 bg-green-50',
                blue: 'border-blue-400 bg-blue-50',
                emerald: 'border-emerald-400 bg-emerald-50',
                yellow: 'border-yellow-400 bg-yellow-50',
                lime: 'border-lime-400 bg-lime-50',
                amber: 'border-amber-400 bg-amber-50',
                teal: 'border-teal-400 bg-teal-50',
                cyan: 'border-cyan-400 bg-cyan-50'
            };
            CROPS.forEach(crop => {
                const card = document.createElement('div');
                card.id = `crop-card-${crop.id}`;
                card.className = `crop-card rounded-xl overflow-hidden border-2 ${colorMap[crop.color] || 'border-gray-300 bg-gray-50'} match-inactive`;
                card.title = `${crop.name} (${crop.variety})\n${crop.params}`;
                card.innerHTML = `
                    <img src="${crop.image}" alt="${crop.name}"
                        class="w-full h-[90px] object-cover"
                        onerror="this.onerror=null;this.src='https://placehold.co/200x90/e8f5e9/2e7d32?text=${encodeURIComponent(crop.icon)}'">
                    <div class="p-2">
                        <p class="text-xs font-bold text-gray-800 leading-tight">${crop.name}</p>
                        <p class="text-[10px] text-gray-500 italic">${crop.variety}</p>
                        <div class="mt-1 text-[9px] text-gray-500 space-y-0.5">
                            <span class="block">üíß ${crop.waterMin}‚Äì${crop.waterMax}cm</span>
                            <span class="block">üß™ ${crop.tdsMin}‚Äì${crop.tdsMax}ppm</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // =============================================
        // CHARTS
        // =============================================
        Chart.defaults.font.family = "'Roboto', sans-serif";
        Chart.defaults.color = '#6b7280';

        const charts = {
            turbidity: createChart('chart-turbidity', 'Turbidity (NTU)', '#3b82f6'),
            water: createChart('chart-water', 'Water Depth (cm)', '#6366f1'),
            tds: createChart('chart-tds', 'TDS (ppm)', '#eab308')
        };

        function createChart(id, label, color) {
            return new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels: [], datasets: [{ label, data: [], borderColor: color, backgroundColor: color + '22', fill: true, tension: 0.4, pointRadius: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: true, text: label } },
                    scales: { x: { display: false }, y: { beginAtZero: true } },
                    animation: { duration: 0 }
                }
            });
        }

        function pushChart(chart, value) {
            const now = new Date().toLocaleTimeString();
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(value);
            if (chart.data.labels.length > maxPoints) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
            chart.update();
        }

        // =============================================
        // GEMINI AI LOGIC
        // =============================================
        async function callGeminiAI() {
            const btn = document.getElementById('gemini-btn');
            const resultBox = document.getElementById('gemini-result');
            const contentBox = document.getElementById('gemini-content');

            // UI Loading State
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Analyzing...`;
            resultBox.classList.remove('hidden');
            contentBox.innerHTML = `<p class="animate-pulse text-gray-400">Consulting Gemini AI...</p>`;

            // Gather Data
            const { turbidity, waterDepth, tds } = currentData;
            const weather = weatherData.loaded ?
                `${weatherData.forecast}, ${weatherData.temp}¬∞C, Humidity ${weatherData.humidity}%` :
                "Weather data unavailable";

            // Construct Prompt
            const prompt = `
                Act as an expert Indian Agricultural Scientist. Analyze this field data:
                - Water Depth: ${Math.floor(waterDepth)} cm
                - Turbidity: ${turbidity} NTU
                - Salinity (TDS): ${tds} ppm
                - Current Weather: ${weather}
                - Location context: India (likely flood-prone region).

                Provide a concise agricultural advisory (max 150 words) covering:
                1. Current Field Status (Safe/Danger)
                2. Recommended Immediate Action
                3. Best Crop Choice for these specific conditions.
                
                Format with bold headings.
            `;

            try {
                // Using gemini-1.5-flash for better compatibility
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message || "API Error");
                }

                if (data.candidates && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    // Simple markdown parsing for bold and newlines
                    const formattedText = aiText
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>');

                    contentBox.innerHTML = formattedText;
                } else {
                    throw new Error("No candidates returned from AI");
                }
            } catch (error) {
                console.error("Gemini Error:", error);
                contentBox.innerHTML = `<p class="text-red-500"><i class="fas fa-exclamation-circle"></i> Analysis failed: ${error.message}. <br>Please check console for details.</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-brain"></i> Analyze Field with AI`;
            }
        }

        // Make function globally available
        window.callGeminiAI = callGeminiAI;

        // =============================================
        // CORE DASHBOARD REFRESH
        // =============================================
        function refreshDashboard() {
            const { turbidity, waterDepth, rawDistance, tds } = currentData;

            // Sensor UIs
            updateSensorUI(ui.turbidity, ui.turbidityBar, ui.turbidityStatus, turbidity, 1000,
                v => v < 50 ? "Crystal Clear" : v < 200 ? "Moderate" : v < 500 ? "Turbid" : "Very Turbid");

            ui.water.innerText = Math.floor(waterDepth);
            ui.rawDist.innerText = Math.floor(rawDistance);
            const wp = Math.min((waterDepth / SENSOR_MAX_HEIGHT_CM) * 100, 100);
            ui.waterBar.style.width = wp + '%';
            ui.waterStatus.innerText = waterDepth >= 50 ? "Flood Level" : waterDepth >= 15 ? "Moderate Water" : waterDepth >= 5 ? "Shallow" : "Dry / Moist";

            updateSensorUI(ui.tds, ui.tdsBar, ui.tdsStatus, tds, 2000,
                v => v < 300 ? "Excellent" : v < 700 ? "Good" : v < 1200 ? "Moderate" : "High Salinity");

            pushChart(charts.turbidity, Math.floor(turbidity));
            pushChart(charts.water, Math.floor(waterDepth));
            pushChart(charts.tds, Math.floor(tds));

            calculateBestMatch();
        }

        function updateSensorUI(elVal, elBar, elStatus, value, max, msgFn) {
            elVal.innerText = Math.floor(value);
            elBar.style.width = Math.min((value / max) * 100, 100) + '%';
            elStatus.innerText = msgFn(value);
        }

        // =============================================
        // CROP MATCHING ENGINE (Sensor + Climate-Smart)
        // =============================================
        function calculateBestMatch() {
            const { turbidity, waterDepth, tds } = currentData;

            // --- Step 1: Check for climate override ---
            let climateResult = { isOverride: false };
            if (weatherData.loaded) {
                climateResult = getClimateSmartCrop(
                    waterDepth, tds, turbidity,
                    weatherData.temp, weatherData.humidity, weatherData.forecast
                );
            }

            // --- Step 2: Score all crops by sensor data ---
            let bestSensorCrop = null;
            let bestScore = -1;

            CROPS.forEach(crop => {
                let score = 0;
                const wIn = waterDepth >= crop.waterMin && waterDepth <= crop.waterMax;
                const tIn = turbidity >= crop.turbidityMin && turbidity <= crop.turbidityMax;
                const sIn = tds >= crop.tdsMin && tds <= crop.tdsMax;
                if (wIn) score += 3;
                if (tIn) score += 2;
                if (sIn) score += 2;
                if (wIn && tIn && sIn) score += 3;

                const el = document.getElementById(`crop-card-${crop.id}`);
                if (el) {
                    el.classList.remove('match-active', 'match-inactive', 'climate-override');
                    if (wIn && tIn && sIn) el.classList.add('match-active');
                    else el.classList.add('match-inactive');
                }

                if (score > bestScore) { bestScore = score; bestSensorCrop = crop; }
            });

            // --- Step 3: Apply climate override if triggered ---
            let finalCrop = bestSensorCrop;
            let finalName = bestSensorCrop ? `${bestSensorCrop.name} (${bestSensorCrop.variety})` : "No Match";
            let finalReason = bestSensorCrop ? bestSensorCrop.description : "Conditions unclear.";
            let finalImage = bestSensorCrop ? bestSensorCrop.image : "";
            let isClimateOverride = false;

            if (climateResult.isOverride && climateResult.cropId) {
                const overrideCrop = CROPS.find(c => c.id === climateResult.cropId);
                if (overrideCrop) {
                    finalCrop = overrideCrop;
                    finalName = climateResult.crop;
                    finalReason = climateResult.reason;
                    finalImage = overrideCrop.image;
                    isClimateOverride = true;

                    // Highlight the override card
                    const el = document.getElementById(`crop-card-${overrideCrop.id}`);
                    if (el) {
                        el.classList.remove('match-inactive', 'match-active');
                        el.classList.add('climate-override');
                    }
                }
            }

            // --- Step 4: Update UI ---
            ui.recCrop.innerText = finalName;
            ui.recReason.innerText = finalReason;
            ui.cropBannerImg.src = finalImage;
            ui.cropBannerImg.style.display = finalImage ? 'block' : 'none';
            ui.climateTag.classList.toggle('hidden', !isClimateOverride);

            // Climate advisory
            if (isClimateOverride && climateResult.advisoryMsg) {
                ui.climateAdvisory.innerText = climateResult.advisoryMsg;
                ui.climateAdvisory.classList.remove('hidden');
                ui.climateOverrideBadge.classList.remove('hidden');
            } else {
                ui.climateAdvisory.classList.add('hidden');
                ui.climateOverrideBadge.classList.add('hidden');
            }

            // Param tags
            ui.cropParamsDisplay.innerHTML = `
                <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">üíß ${Math.floor(waterDepth)} cm</span>
                <span class="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">üåä ${Math.floor(turbidity)} NTU</span>
                <span class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">üß™ ${Math.floor(tds)} ppm</span>
                ${weatherData.loaded ? `<span class="text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">${weatherData.icon} ${weatherData.temp}¬∞C ¬∑ ${weatherData.forecast}</span>` : ''}
            `;

            // Safety badge
            const isSafe = finalCrop && tds < 1500 &&
                waterDepth >= finalCrop.waterMin && waterDepth <= finalCrop.waterMax;
            if (tds > 1800) {
                ui.safetyBadge.innerText = "‚ö† UNSAFE";
                ui.safetyBadge.className = "px-4 py-2 rounded-full text-sm font-bold bg-red-100 text-red-700";
                ui.banner.className = "mb-8 p-5 rounded-xl border-l-8 shadow-sm flex items-center gap-5 transition-colors duration-500 bg-red-50 border-red-500";
            } else if (isSafe) {
                ui.safetyBadge.innerText = "‚úì SAFE";
                ui.safetyBadge.className = "px-4 py-2 rounded-full text-sm font-bold bg-green-100 text-green-700";
                ui.banner.className = "mb-8 p-5 rounded-xl border-l-8 shadow-sm flex items-center gap-5 transition-colors duration-500 bg-green-50 border-green-500";
            } else {
                ui.safetyBadge.innerText = "‚ö° MARGINAL";
                ui.safetyBadge.className = "px-4 py-2 rounded-full text-sm font-bold bg-yellow-100 text-yellow-700";
                ui.banner.className = "mb-8 p-5 rounded-xl border-l-8 shadow-sm flex items-center gap-5 transition-colors duration-500 bg-yellow-50 border-yellow-500";
            }
        }

        // =============================================
        // FIREBASE
        // =============================================
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getDatabase(app);

            signInWithEmailAndPassword(auth, "giannamartinkunnassery@gmail.com", "qwerty")
                .then(() => {
                    ui.statusText.innerText = "Live Connected";
                    ui.statusDot.className = "w-2.5 h-2.5 rounded-full shadow-md bg-green-500";

                    onValue(ref(db, '/sensor_data'), (snapshot) => {
                        const val = snapshot.val();
                        if (val && (val.turbidity !== undefined || val.jsn !== undefined)) {
                            ui.simToggle.checked = false;
                            handleSimToggle();
                            const dist = val.jsn || val.water_level || val.distance || 0;
                            currentData = {
                                turbidity: val.turbidity || 0,
                                rawDistance: dist,
                                waterDepth: Math.max(0, SENSOR_MAX_HEIGHT_CM - dist),
                                tds: val.tds || 0
                            };
                            refreshDashboard();
                        }
                    });
                })
                .catch(e => console.error("Auth:", e));
        } catch (e) { console.error("Firebase:", e); }

        // =============================================
        // SIMULATION
        // =============================================
        function handleSimToggle() {
            const enabled = ui.simToggle.checked;
            [ui.simTurbidity, ui.simWaterDepth, ui.simTDS].forEach(el => el.disabled = !enabled);
            ui.simPanel.classList.toggle('opacity-60', !enabled);
            if (enabled) {
                if (!window.simInterval) { readSim(); window.simInterval = setInterval(readSim, 2000); }
            } else {
                clearInterval(window.simInterval); window.simInterval = null;
            }
        }

        function readSim() {
            if (!ui.simToggle.checked) return;
            const d = parseInt(ui.simWaterDepth.value);
            const t = parseInt(ui.simTurbidity.value);
            const s = parseInt(ui.simTDS.value);
            currentData.waterDepth = Math.max(0, d + (Math.random() * 2 - 1));
            currentData.turbidity = Math.max(0, t + (Math.random() * 10 - 5));
            currentData.tds = Math.max(0, s + (Math.random() * 20 - 10));
            currentData.rawDistance = SENSOR_MAX_HEIGHT_CM - currentData.waterDepth;

            document.getElementById('disp-sim-turbidity').innerText = Math.floor(currentData.turbidity);
            document.getElementById('disp-sim-water').innerText = Math.floor(currentData.waterDepth) + " cm";
            document.getElementById('disp-sim-tds').innerText = Math.floor(currentData.tds);
            refreshDashboard();
        }

        ui.simToggle.addEventListener('change', handleSimToggle);
        ui.simTurbidity.addEventListener('input', readSim);
        ui.simWaterDepth.addEventListener('input', readSim);
        ui.simTDS.addEventListener('input', readSim);

        // Date
        setInterval(() => {
            ui.dateDisplay.innerText = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }, 1000);

        // =============================================
        // INIT
        // =============================================
        buildCropCards();
        handleSimToggle();
        fetchWeather();
        // Refresh weather every 10 minutes
        setInterval(fetchWeather, 10 * 60 * 1000);

    </script>
</body>

</html>
